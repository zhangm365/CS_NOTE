
# `RocksDB` 放大系数分析

本文梳理 [`RocksDB`](https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide) 压缩（compaction）过程中的放大系数因素，主要包括写放大、读放大和空间放大三个方面。
> 存储设备是基于闪存存储技术的非易失性固态硬盘（`SSD`）。`Flash Memory` 在重写之前需要电擦除数据。

这些放大系数将用户的逻辑请求大小和 `RocksDB` 对底层硬件的请求两者之间进行了关联。

## 1. 写放大（Write amplification）

写放大是写入存储设备的字节数与写入数据库的字节数之比。
例如，现在以 `10MB/s` 速度向数据库中写入数据，而观察到磁盘的写入速度为 `30MB/s`，那么写放大系数就是 3。

因此，如果写入放大率较高，那么工作负载可能容易在磁盘吞吐量上遇到瓶颈。
同时，高写入放大率会严重缩短闪存的寿命。

在 `RocksDB` 中，有两种方式获取当前的写入放大率：

1. 获取函数 `DB::GetProperty("rocksdb.stats", &stats)` 的输出结果；

    ```c++
    // db/db_impl/db_impl.cc
    rocksdb::DB* db;
    rocksdb::DB::Open(rocksdb::Options(), "/path/to/db", &db);
    std::string stats;
    /*
     *  "rocksdb.stats" - returns a multi-line string containing the data
     *      described by kCFStats followed by the data described by kDBStats.
    */
    if(rocksdb::DB::GetProperty("rocksdb.stats", &stats)) {
        
    }
    ```

2. 使用磁盘写入带宽除以 `DB` 写入速率。
其中，磁盘写入带宽可以通过 `iostat` 命令获取。

## 2. 读放大（Read amplification）

读放大是指每次查询的磁盘读取数量。

例如，如果每次查询需要读取 5 页数据，那么读放大系数就是 5。

逻辑读是指从缓存中读取数据，例如 `RocksDB block cache` 和 `OS page cache`。
物理读是指从存储设备中读取数据，例如 `HDD` 和 `SSD`。

## 3. 空间放大（Space amplification）

空间放大是指存储设备上的数据库文件大小与实际数据的大小之比。

例如，你将 10MB 数据写入数据库，但它占用 100MB 的磁盘空间，那么空间放大系数就是 10。

我们需要对空间放大进行硬性限制，以避免磁盘或内存空间不足。

一般来说，一个数据结构可以最多针对读取、写入和空间放大三者中的两个进行优化。这意味着一个数据结构不太可能在这三个方面都比另一个更好。例如，`B-Tree` 比 `LSM-Tree` 具有较低的读放大，而 `LSM-Tree` 比 `B-Tree` 具有较低的写放大。`LSM-Tree` 可通过缓存技术来减少读放大，从而提升读性能。
