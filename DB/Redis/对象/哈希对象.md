# 哈希对象

哈希对象的编码可以是`ziplist` 或 `hashtable`。

# 1. `ziplist` 编码

`ziplist`编码的哈希对象是使用 **压缩列表** 作为底层实现。

每当有新的键值对要加入哈希对象时，`redis` 会先将保存了键的节点推入压缩列表尾部，接着将保存了值的节点推入压缩列表尾部。因此，采用压缩列表编码的哈希对象有以下特征：

1. 保存同一键值对的两个节点总是紧挨在一起，保存键的节点在前，值的节点在后；
2. 先添加的键值对在压缩列表的表头方向，后加入的键值对在压缩列表的表尾方向。

## 1.1 实现

如下是`ziplist`编码的哈希对象：

```shell
127.0.0.1:6379> hset profile name "Tom" age 25 career "programmer"
(integer) 3
127.0.0.1:6379> type profile
hash
127.0.0.1:6379> object encoding profile
"ziplist"
```

以下是`profile`键的值对象使用的`ziplist`编码格式：

![](../pics/hash_zl.png)

压缩列表的实现的哈希对象：

![](../pics/hash_zl_2.png)

# 2. `hashtable`编码

`hashtable`编码的哈希对象使用 **字典** 作为底层实现，哈希表对象中的每个键值对都使用一个字典键值对保存：

1. 字典的每个键都是一个字符串对象，对象中保存了键值对的键；
2. 字典的每个值都是一个字符串对象，对象中保存了键值对的值。

# 3. 编码转换

`ziplist`编码的哈希对象需要满足以下两个条件：

1. 哈希对象保存的所有键值对的键和值的字符串长度都小于`64`字节；
2. 哈希对象保存的键值对数量小于`512`个。

在`redis.conf`配置文件中，由以下两个参数控制：

```c
hash-max-ziplist-entries 512    // 压缩列表中的最大元素个数
hash-max-ziplist-value 64    // 每个字符串的最大长度
```

当`ziplist`编码的哈希对象所需的两个条件的任意一个不满足时，对象的编码转换就会被执行，即由`ziplist`转到`hashtable`编码。

```shell
127.0.0.1:6379> object encoding profile
"ziplist"
# 长度大于64字节的字符串
127.0.0.1:6379> hset profile address "china guangdong guangzhou sun yat sen university computer science school robot hello world" 
(integer) 1
127.0.0.1:6379> type profile
hash
127.0.0.1:6379> object encoding profile
"hashtable"    # 由ziplist变成hashtable
```

# 4. 哈希命令

`HSET`、`HGET`。