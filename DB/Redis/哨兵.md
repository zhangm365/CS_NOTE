# 哨兵机制

哨兵是 `redis` 中重要的一种机制。`redis` 主从复制是保证 `redis` 高可用性的一个重要手段。哨兵实例运行后，会周期性检查它所监控的主节点的运行状态。

`redis` 通常会部署多个哨兵实例来监控主节点的状态，这样避免单个哨兵出现误判的现象。当主节点发生故障时，哨兵就会执行故障切换流程。

# 1. 哨兵的启动

在 `redis` 中可以通过两种方式启动哨兵实例：

1. 直接运行 `redis-sentinel` 命令；
2. 运行 `redis-server` 命令时，带有参数 `--sentinel`。 

# 2. 哨兵实例的初始化

哨兵实例是属于运行在一种特殊模式下的 `redis server`。

哨兵实例的初始化在入口函数 `main` 中，通过 `checkForSentinelMode` 函数来判断当前是否为哨兵实例。

```c
int checkForSentinelMode(int argc, char **argv) {
    int j;
    if (strstr(argv[0],"redis-sentinel") != NULL) return 1;
    for (j = 1; j < argc; j++)
        if (!strcmp(argv[j],"--sentinel")) return 1;
    return 0;
}
```

如果启动了哨兵实例，则全局参数 `server.sentinel_mode` 会被置为 `1`。

# 3. 哨兵实例结构

哨兵实例的数据结构是通过 `sentinelRedisInstance` 来描述的。它会记录监听的主节点的信息，同时也记录了监听同一主节点的其他哨兵的信息。

# 4. 哨兵 `Leader` 选举

当多个哨兵判断出主节点故障后，那么由谁来执行故障切换呢？此刻，哨兵会进行 `Leader` 选举，这个过程设计分布式系统中的共识协议：`Raft` 协议。这个协议对分布式系统中实现 **分布式共识** 有重要的指导作用。

`Raft` 协议用来实现分布式共识，这是一种在分布式系统中实现多节点达成一致性的算法，可以用来在多个节点中选举出 `Leader` 节点。
