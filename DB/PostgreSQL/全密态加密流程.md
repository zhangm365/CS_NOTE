
# `全密态数据库流程`

本项目是基于 `openGauss-server` 的全密态数据库，以下是代码解读与分析。

# 0. `数据结构`

函数 `PQsendQuery` 构造 `StatementData` 结构体，该结构体包含了 `SQL` 语句的各种信息，如下：

1. `PQsendQuery` 函数

    ```cpp
    /* \src\common\interfaces\libpq\fe-exec.cpp */
    int PQsendQuery(PGconn* conn, const char* query) {
        // 加密操作
        StatementData statementData (conn, query);
        bool clientLogicRet = Processor::run_pre_query(&statementData);
    }
    ```

2. `StatementData` 结构体

    ```cpp
    /* src\common\interfaces\libpq\client_logic_common\statement_data.h */
    typedef struct StatementData {
    public:
        StatementData(PGconn *aconn, const char *aquery)
            : conn(aconn),
            query(aquery),
            stmtName(NULL),
            nParams(0),
            paramTypes(0),
            paramValues(0),
            paramLengths(0),
            paramFormats(0),
            offset(0) {};

        void replace_raw_values();
        /*
        *  @brief copy all params from statment data to params structure and allocating memory for adjusted
        */
        void copy_params();
        ICachedColumnManager* GetCacheManager() const;
        ~StatementData();

    private:
        const size_t get_total_change() const;

    public:
        PGconn *conn;
        const char *query;  /* query string */
        const char *stmtName;
        size_t nParams;
        const Oid *paramTypes;
        const char * const * paramValues;
        const int *paramLengths;
        const int *paramFormats;
        PGClientLogicParams params;    /* params structure: encryption params */
        size_t offset;
    } StatementData;
    ```

3. 主密钥（`CMK`）

    保存客户端主密钥的数据信息：

    ```cpp
        // \src\include\nodes\parsenodes_common.h
        typedef struct CreateClientLogicGlobal {
            NodeTag type;
            List *global_key_name;    /* 主密钥名称 */
            List *global_setting_params;    /* 主密钥参数，每一个参数是 ClientLogicGlobalParam */
        } CreateClientLogicGlobal;
    ```

    因此，客户端主密钥创建语法本质上是将 `CMK` 元信息解析保存在 `CreateClientLogicGlobal` 结构体中。

## 1. `select` 语句流程
