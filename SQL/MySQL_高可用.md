[toc]

# MySQL 高可用原理

--------------------------

## 1. MySQL 主备延迟

备库执行主库生成的 `binlog` 日志文件会有时间差值，因此，主库备库之间的数据备份是存在延迟的。在备库执行命令 `show replica status` 显示主备库之间状态信息，其中参数 `Seconds_Behind_Source` 表示备库延迟处理主库的 `binlog` 日志文件多少秒，这个数值如果很大 ( 一直增加 )，说明备库无法及时处理主库的事件。

### 1.1 主备延迟的差值计算方法

1.  主库执行完一个事务，写入 `binlog` 日志，时间记为 `T1`；
2.  备库收到主库发来的事务，执行完这个事务，时间记为 `T2`；

上述两者的时间戳可以作为主备延迟的秒级数值。

### 1.2 主备延迟的来源

#### a. 备库所在的机器部署比主库的性能差

这种情况目前很少见，因为，通常会发生主备切换操作，主备库会进行对称部署。

#### b. 备库压力大

可以进行一主多从部署，除备库外，可以多接几个从库进行分担压力。

#### c. 执行的是大事务

典型的案例一：在表中一次性删除大量数据；另一个是大表上做 `DDL` 操作 [(第 13 讲)](![image-20210726110608570](C:\Users\a7792\AppData\Roaming\Typora\typora-user-images\image-20210726110608570.png))。

## 2. 主备切换的策略

进行主备切换时，由于主备延迟可能会导致数据不一致。因此，需要不同的策略保证主备库的数据一致。

### 2.1 可靠性优先策略

主备库进行切换时，备库要判断参数 `Seconds_Behind_Source` 值是否要小于某个阈值，如果小于设定的阈值，就设置主库为只读状态，当备库的 `Seconds_Behind_Source` 值为 `0` 时，然后进行主备切换，即将备库改为主库，把业务请求连接到新的主库。在这个切换过程中，系统存在不可用时间。这样保证了主备库数据的一致性，但是系统可能处于停摆的状态。

### 2.2 可用性优先策略

尽可能将「可靠性优先」中的系统不可用时间降为 `0`，即业务操作时直接进行主备切换。这样有利于业务请求可以及时响应，但是可能会导致主备库中的数据不一致问题。