[toc]

# MySQL 误删数据恢复

-------------------

## 1. 误删行

对于 `delete` 语句误删的行记录，可以通过 `Flashback` 工具恢复数据。`Flashback` 工具恢复数据的原理是：
修改 `binlog` 日志内容，拿回原库重放。`binlog` 日志要确保是 `row-based` 和 `binlog_row_image=FULL` 的设置。
具体恢复数据时，单个事务的执行流程如下：

1.  对于 `insert` 语句，日志文件的`Event_type` 是 `Write_rows` 事件类型，把它改为 `Delete_rows` 类型即可；
2.  对于 `delete` 语句，则改为 `Write_rows` 类型；
3.  对于 `update` 语句，`binlog` 日志中保留了修改前后的记录，对调这两部分的执行顺序即可。

但是，恢复数据时，不要在原库上直接操作，最好恢复出一个备份库或者在找一个从库作为临时库，在临时库上执行这些操作，再将确认好的临时库数据恢复到原库。

## 2. 误删库/表

对于删表：`drop/truncate table` 和 删库：`drop database` 操作删除的数据就无法通过 `Flashback` 工具来恢复了，因为即使我们配置了 `binlog_format=row`，但执行这三个命令时，`binlog` 日志中记录的是 `statement` 格式，文件中只有一个 `truncate/drop` 语句，无法用来恢复数据的。 
在发生误删表或库操作后，可以 **全量备份+增量备份** 的方式来恢复数据。这个方案要求线上库必须要有定期的全量备份，并且有实时备份 `binlog` 日志。
全量备份：指数据库定期进行备份全部数据的操作，可以通过 `mysql` 自带的工具 `mysqldump` 来操作备份。
增量备份：就是对线上库操作过程中生成的 `binlog` 日志文件。

假如中午12点误删了某个库，这时恢复数据的流程如下：

1.  取最近一次全量备份，如果这个库是一天一备，上次备份时间是当天 0 点；
2.  用备份恢复出一个临时库；
3.  从日志备份里取出凌晨 0 点之后的日志；
4.  把这些日志，除了误删数据的语句操作外，全部应用到临时库中。

这个流程图如下：
![](.\pictures\31_1.jpg)

关于这个过程，有以下两点说明：

1.  想要加速恢复数据的话，如果是误删某个库/库中的某个表，而且临时库上有很多数据库，可以应用 `mysqlbinlog` 命令时，加上一个 `-database` 参数，用来指定被误删的库。这样就可以只把日志应用到被删的库中，避免还应用到其他库中。但是 `mysqlbinlog` 命令只能指定被误删的库，而不能指定误删的数据表。
2.  在应用日志的时候，需要跳过那个 12 点误删语句的 `binlog` 。

综上，在误删库或表后，恢复数据的思路主要就是通过备份，再加应用 `binlog` 的方式。

## 3. 延迟复制备库

如果一个库特别大，或者误操作时间离上次全量备份时间较长，那么用全量备份恢复一个临时库时，那么这个恢复时间是非常长的。
如果是核心业务，不允许这么长的恢复时间。这时可以考虑搭建延迟复制的备库。
一般的主备库的结构中，在主库上删除一个表后，这个命令很快发给其他所有从库 ，导致所有库中这个表都被删除了。
所以，`MySQL 5.6` 允许搭建延迟复制备库。
延迟复制的备库就是一个特殊的备库，允许设置当前从库与主库有 `N` 秒的延迟，通过命令 `CHANGE MASTER TO MASTER_DELAY = N` 来设置。 
在搭建了延迟复制备库后，可以快速恢复主库上误删的表数据。