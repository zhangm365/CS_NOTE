# 有序集合 `Sorted Set`

有序集合是一种重要的数据结构，它本身是集合类型，集合中的元素带有权重并按权重排序。
有序集合底层的数据结构是由 **跳表** 和 **哈希表** 组成的，跳表支持范围查询，哈希表支持以常数时间复杂度获取元素权重，因此有序集合可以支持高效的 **范围查询** 和 **单点查询**。

## 1. 跳表 `skiplist`

有序集合的结构定义在 `server.h`， 实现文件在 `z_set.c` 文件。
有序集合的相关结构定义如下：

```c
/* 跳表节点定义 */
typedef struct zskiplistNode {	
    sds ele;    // Sorted Set 中的元素值
    double score;    // 元素的权重值
    struct zskiplistNode *backward;    // 后向指针，指向前一个节点
    // 节点的 level 数组
    struct zskiplistLevel {
        struct zskiplistNode *forward;    // 前向指针，指向下一个节点
        unsigned long span;    // 每个节点的跨度，表示跨越当前层上的几个节点
    } level[];
} zskiplistNode;

// 跳表的定义
typedef struct zskiplist {
    struct zskiplistNode *header, *tail;    // 指向跳表的头节点和尾节点
    unsigned long length;    // 跳表的长度
    int level;    // 最大层数
} zskiplist;

// 有序集合的定义
typedef struct zset {
    dict *dict;    // 哈希表的指针
    zskiplist *zsl;    // 跳表的指针
} zset;
```

跳表是一个「**有序链表+多层索引**」的结构，查询元素的时间复杂度是 `O(logn)`。它的结构如下：
![](./pics/skl_1.png)

