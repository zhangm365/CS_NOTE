# `Redis`事件

`Redis`服务器是一个事件驱动程序，主要处理以下两种事件：

1. 文件事件：`Redis`服务器通过套接字与客户端（或其他服务器）进行通信，即文件事件就是服务器对套接字操作的抽象。
2. 时间事件：`Redis`服务器中的一些操作（如`serverCron`）需要在给定的时间点执行，即时间事件就是服务器对这类定时操作的抽象。

# 1. 文件事件

`Redis`基于`Reactor`模式开发了自己的网络事件处理器，也称文件事件处理器。

文件事件处理器使用`I/O`多路复用来监听多个套接字，实现了高性能的网络通信模型。

## 1.1 事件处理器

事件处理器主要有三类：连接应答处理器、命令请求处理器、命令回复处理器，分别实现不同的网络通信需求。

### 1.1.1 连接应答处理器

`networking.c/acceptTcpHandler`函数是`Redis`的连接应答处理器，它负责对连接服务器的监听套接字的客户端进行应答。

当`Redis`服务器进行初始化时，程序将服务器监听套接字的`AE_READABLE`事件与连接应答处理器关联起来，即监听是否有客户端向服务器发起连接。当有客户端连接服务器时，监听套接字就会产生`AE_READABLE`事件，使得连接应答处理器执行应答操作。

### 1.1.2 命令请求处理器

`networking.c/readQueryFromClient`函数是`Redis`的命令请求处理器，它负责从套接字读取客户端发送的命令请求内容。

当一个客户端成功连接服务器后，服务器会将客户端套接字的`AE_READABLE`事件与命令请求处理器进行关联。当客户端向服务器发送命令请求时，套接字就会产生`AE_READABLE`事件，使得命令请求处理器执行客户端的命令请求。

### 1.1.3 命令回复处理器

`networking.c/sendReplyToClient`函数是`Redis`的命令回复处理器，它负责将服务器执行命令后的结果写回到客户端的已连接套接字。当服务器执行收到的命令并进行命令回复时，服务器会将客户端套接字的`AE_WRITEABLE`事件与命令回复处理器进行关联。

一次完整的服务器与客户端通信过程如下：	

![](./pics/fileEv_1.png)

# 2. 时间事件

持续运行的`Redis`服务器需要定期对自身的资源和状态进行检查和调整，以保证服务器长期、稳定地运行。这个定期操作在`server.c/serverCron`函数负责执行，即`Redis`服务器以周期性的方式来运行`serverCron`函数，在服务器运行期间，每隔`100`毫秒，`serverCron`就会执行一次，直至服务器关闭。