- [`AOF & RDB`](#aof--rdb)
  - [1. `AOF` 日志](#1-aof-日志)
    - [1.1 `AOF` 日志重写](#11-aof-日志重写)
    - [1.2 实现方式](#12-实现方式)
  - [2. `RDB` 快照](#2-rdb-快照)

# `AOF & RDB`

`AOF` 日志和 `RDB` 快照是 `redis` 中数据持久化的两种方式，保证了 `redis` 数据库中的数据可靠性。

# 1. `AOF` 日志

`AOF` 日志以 "命令+键值对" 的形式来追加记录每个键值对的 **写操作**。主线程在处理客户端的读写需求时，写操作会被主线程正常写入到 `AOF` 日志文件。

## 1.1 `AOF` 日志重写

当 `redis server` 的写请求很多，`AOF` 会记录接收到的所有写操作，会导致`AOF`日志文件也会越来越大。

为了避免 `AOF` 日志文件过大，`redis` 会对 `AOF` 文件进行重写，即针对当前数据库每个键值对的最新内容，记录它的插入操作，不再记录它的历史写操作了，这样重写后的 `AOF` 日志会变小。

### 1.1.1 实现方式

`AOF` 重写日志是通过创建 **子进程** 来重写数据的，这样可以避免阻塞主线程，减少对 `redis` 整体性能的影响。

在主进程执行写操作时，`AOF` 重写子进程会尽可能执行从主线程发来的写命令。父子进程间通信是通过 `pipe` 管道机制来通信的。

建立的管道有 `3` 个：操作命令发送管道和 `2` 个`ACK` 信息发送管道。

# 2. `RDB` 快照

`RDB` 快照是记录 `redis` 数据库某个时刻的全部数据，只记录键值对数据本身，是以二进制形式存放的。

