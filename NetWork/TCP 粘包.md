# `TCP` 粘包

## 1. 什么是粘包

`TCP` 是面向连接的、基于字节流、可靠的传输控制协议。

因为基于字节流的数据包是没有任何边界的，`TCP` 粘包就是由于 "**基于字节流**" 这个特性导致的。当发送方的多个数据包粘合在一起，接收方无法准确分割数据包来还原最初的数据包大小，就出现 `TCP` 粘包的现象。

## 2. 粘包的原因

### 2.1 发送方原因

当发送方发送的数据包较小且发送间隔较短时，一个数据包长度没有达到 `MSS` 时，就会等待下一个数据包一起发送，这样可以提高传输效率和减少网络拥塞，但会导致 `TCP` 粘包问题。`TCP` 默认使用 `Nagle` 算法优化，就是进行上述操作，目的是为了避免发送小的数据包。

可以使用选项 `TCP_NODELAY` 选项来关闭算法。

### 2.2 接收方原因

接收方接收的数据包放在缓存区，应用程序会主动读取缓存区的数据分组。如果接收方处理数据包的速度小于 `TCP` 接收数据包到缓冲区的速度时，那么多个数据包就会被缓存，也会导致粘包问题。

## 2. 如何处理粘包问题

粘包出现的根本原因是由于不确定数据包的边界。有以下常用的方法：

1. 加入数据包的长度信息：每次发送数据包时，加入数据包的长度信息；
2. 格式化数据包：每个数据包都有固定格式，比如加入固定的开始符和结束符来区分不同的数据包。





