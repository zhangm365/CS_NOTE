# TCP协议

## 1. TCP协议头部结构

TCP头部结构如下：

![avatar](tcp_head.png)

-   16位端口号：告知主机该报文段来着哪里(源端口)以及传给哪个上层协议或应用程序(目的端口)。知名服务的端口号定义在/etc/services文件中。

-   32位序列号：一次TCP通信(从TCP连接建立到断开)过程中某一个传输方向上的字节流的每个报文段的编号。

    假设，主机A与主机B建立TCP通信，A发送给B的第一个TCP报文段中，序号值被系统初始化为某个随机值(ISN)。此后，在该传输方向上(A--->B)，后续的TCP报文段的序号值将是ISN+该报文段携带数据的第一个字节在整个字节流中的偏移。例如，某个TCP报文段中传送的数据是字节流第1025~2048字节，那么整个报文段的序号即为ISN+1025。同理，从B到A传输方向也是相同的编号规则。

-   32位确认号：用作另一方发送来的TCP报文段的响应。

    其值是收到TCP报文段的序号值加1。例如，在上面的阐述中，当B给A发送TCP报文段时，这个发出的报文段同时也携带自己的序列号和对A发送来的报文段的确认号(ISN+1025+1)。

-   4位头部长度：标识TCP头部的大小。4bits最大表示值为15，故TCP头部最长可为60个字节。

-   6位标记位含义如下：
    -   URG：标记紧急指针是否有效；
    -   ACK：表示确认号是否有效；携带ACK标记位的TCP报文段也称**确认报文段**；
    -   PSH：接收端应用程序应该立即从TCP接受缓冲区中读走数据，为接受后续数据腾出空间。
    -   RST：要求对方重新建立连接；
    -   SYN：表示请求建立一个连接。携带SYN标记位的TCP报文段也称**同步报文段**；
    -   FIN：表示通知对方本端要关闭连接了。携带FIN报文段的报文也称**结束报文段**；

-   16位窗口大小：TCP流量控制的一个手段。这里的窗口是指接收通告窗口。它告诉对端，本端的TCP接收缓冲区还能接收多少字节的数据，这样接收方就可以控制发送方的发送数据的速度。
-   16位校验和：由发送端填充，接收端对TCP报文段执行CRC算法以校验TCP报文段在传输过程中是否损坏。这是TCP可靠传输的一个重要保障。